#!/usr/bin/env bash
set -e

CONFIG_DIR="$HOME/.config/devobox"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Available databases list
DATABASES=("postgres" "redis")
CONTAINERS=("devobox" "${DATABASES[@]}")

show_help() {
    echo -e "${BLUE}ğŸ“¦ Devobox CLI${NC}"
    echo "Uso: devobox [comando]"
    echo ""
    echo "Ambiente:"
    echo "  shell [--with-dbs]  -> Entra no ambiente (use --with-dbs para iniciar DBs)"
    echo "  up                  -> Sobe tudo em background"
    echo "  down                -> Para tudo (libera RAM)"
    echo "  status              -> Mostra containers"
    echo "  rebuild             -> ReconstrÃ³i a imagem"
    echo ""
    echo "Bancos de dados:"
    echo "  db start [service]  -> Inicia todos os bancos ou um especÃ­fico (postgres|redis)"
    echo "  db stop [service]   -> Para todos os bancos ou um especÃ­fico"
    echo "  db restart [service]-> Reinicia todos os bancos ou um especÃ­fico"
    echo "  db status           -> Status dos bancos"
}

check_running() {
    podman container inspect "$1" --format '{{.State.Running}}' 2>/dev/null | grep -q "true"
}

get_container_state() {
    local name="$1"

    if ! podman container inspect "$name" >/dev/null 2>&1; then
        echo "nÃ£o criado"
        return
    fi

    if check_running "$name"; then
        echo "rodando"
    else
        echo "parado"
    fi
}

is_valid_database() {
    local service="$1"
    for db in "${DATABASES[@]}"; do
        if [ "$db" = "$service" ]; then
            return 0
        fi
    done
    return 1
}

start_database() {
    local service="$1"

    if ! is_valid_database "$service"; then
        echo -e "${RED}âŒ Banco '$service' nÃ£o encontrado. OpÃ§Ãµes: ${DATABASES[*]}${NC}"
        return 1
    fi

    if check_running "$service"; then
        echo -e "${YELLOW}âš ï¸  $service jÃ¡ estÃ¡ rodando${NC}"
    else
        echo -e "${BLUE}ğŸ”Œ Iniciando $service...${NC}"
        podman start "$service" >/dev/null
        echo -e "${GREEN}âœ… $service iniciado${NC}"
    fi
}

stop_database() {
    local service="$1"

    if ! is_valid_database "$service"; then
        echo -e "${RED}âŒ Banco '$service' nÃ£o encontrado. OpÃ§Ãµes: ${DATABASES[*]}${NC}"
        return 1
    fi

    if check_running "$service"; then
        echo -e "${BLUE}ğŸ’¤ Parando $service...${NC}"
        podman stop "$service" >/dev/null 2>&1
        echo -e "${GREEN}âœ… $service parado${NC}"
    else
        echo -e "${YELLOW}âš ï¸  $service jÃ¡ estÃ¡ parado${NC}"
    fi
}

start_all_dbs() {
    echo -e "${BLUE}ğŸ”Œ Iniciando todos os bancos...${NC}"
    for db in "${DATABASES[@]}"; do
        start_database "$db"
    done
}

stop_all_dbs() {
    echo -e "${BLUE}ğŸ’¤ Parando todos os bancos...${NC}"
    for db in "${DATABASES[@]}"; do
        stop_database "$db"
    done
}

restart_database() {
    local service="$1"
    stop_database "$service"
    sleep 1
    start_database "$service"
}

restart_all_dbs() {
    echo -e "${BLUE}ğŸ”„ Reiniciando todos os bancos...${NC}"
    for db in "${DATABASES[@]}"; do
        restart_database "$db"
    done
}

show_db_status() {
    echo -e "${BLUE}ğŸ“Š Status dos bancos:${NC}"
    for db in "${DATABASES[@]}"; do
        if check_running "$db"; then
            echo -e "  ${GREEN}â—${NC} $db (rodando)"
        else
            echo -e "  ${RED}â—‹${NC} $db (parado)"
        fi
    done
}

show_containers_status() {
    echo -e "${BLUE}ğŸ“¦ Status dos containers:${NC}"
    printf "%-12s | %-11s\n" "Container" "Estado"
    printf '%s\n' "-----------------------------"

    local missing=0

    for container in "${CONTAINERS[@]}"; do
        local state
        local color

        state=$(get_container_state "$container")

        case "$state" in
            "rodando")
                color="$GREEN"
                ;;
            "parado")
                color="$YELLOW"
                ;;
            "nÃ£o criado")
                color="$RED"
                missing=1
                ;;
        esac

        printf " %-11s | %b%s%b\n" "$container" "$color" "$state" "$NC"
    done

    if (( missing )); then
        echo -e "${YELLOW}âš ï¸  Algum container nÃ£o foi encontrado. Execute 'devobox rebuild' para recriar.${NC}"
    fi
}

case "$1" in
    shell|enter)
        # Check if should start databases
        if [ "$2" = "--with-dbs" ]; then
            start_all_dbs
        fi

        if ! check_running "devobox"; then
             echo -e "${BLUE}   Iniciando Devobox...${NC}"
             podman start devobox >/dev/null
        fi
        echo -e "${GREEN}ğŸš€ Entrando no Devobox...${NC}"
        # Map current host directory to container path
        WORK_DIR=$(pwd | sed "s|$HOME|/home/dev|")
        # Test if directory exists in container, fallback to default
        podman exec devobox test -d "$WORK_DIR" 2>/dev/null || WORK_DIR="/home/dev/code"
        podman exec -it -w "$WORK_DIR" devobox bash
        ;;

    db)
        case "$2" in
            start)
                if [ -z "$3" ]; then
                    start_all_dbs
                else
                    start_database "$3"
                fi
                ;;
            stop)
                if [ -z "$3" ]; then
                    stop_all_dbs
                else
                    stop_database "$3"
                fi
                ;;
            restart)
                if [ -z "$3" ]; then
                    restart_all_dbs
                else
                    restart_database "$3"
                fi
                ;;
            status|ls)
                show_db_status
                ;;
            *)
                echo -e "${RED}âŒ Subcomando invÃ¡lido para 'db'${NC}"
                echo "Uso: devobox db {start|stop|restart|status} [postgres|redis]"
                exit 1
                ;;
        esac
        ;;

    up)
        start_all_dbs
        podman start devobox >/dev/null 2>&1 || true
        echo -e "${GREEN}âœ… Ambiente rodando em background.${NC}"
        ;;

    down|stop)
        echo -e "${BLUE}ğŸ’¤ Parando ambiente...${NC}"
        podman stop devobox postgres redis >/dev/null 2>&1 || true
        echo -e "${GREEN}âœ… Tudo parado.${NC}"
        ;;

    status)
        show_containers_status
        ;;

    rebuild)
        echo -e "${BLUE}ğŸ—ï¸  Reconstruindo ambiente...${NC}"
        cd "$CONFIG_DIR" && make build
        ;;

    *)
        show_help
        ;;
esac
