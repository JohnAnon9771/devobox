#!/usr/bin/env bash
set -e

CONFIG_DIR="$HOME/.config/devobox"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Available databases list (loaded dinamically)
DATABASES=()

load_databases() {
    local config_file="$CONFIG_DIR/databases.conf"

    if [ ! -f "$config_file" ]; then
        echo -e "${RED}‚ùå Arquivo de bancos n√£o encontrado em $config_file${NC}"
        exit 1
    fi

    DATABASES=()

    while IFS='|' read -r name _; do
        name=$(echo "$name" | xargs)

        if [ -z "$name" ] || [[ "$name" == \#* ]]; then
            continue
        fi

        DATABASES+=("$name")
    done < "$config_file"

    if [ ${#DATABASES[@]} -eq 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Nenhum banco configurado em $config_file${NC}"
    fi
}

load_databases
CONTAINERS=("devobox" "${DATABASES[@]}")

show_help() {
    echo -e "${BLUE}üì¶ Devobox CLI${NC}"
    echo "Uso: devobox [comando]"
    echo ""
    echo "Ambiente:"
    echo "  shell [--with-dbs]  -> Entra no ambiente (use --with-dbs para iniciar DBs)"
    echo "  up                  -> Sobe tudo em background"
    echo "  down                -> Para tudo (libera RAM)"
    echo "  status              -> Mostra containers"
    echo "  rebuild             -> Reconstr√≥i a imagem"
    echo ""
    echo "Bancos de dados (definidos em databases.conf):"
    echo "  db start [service]  -> Inicia todos os bancos ou um espec√≠fico"
    echo "  db stop [service]   -> Para todos os bancos ou um espec√≠fico"
    echo "  db restart [service]-> Reinicia todos os bancos ou um espec√≠fico"
    echo "  db status           -> Status dos bancos"
}

check_running() {
    podman container inspect "$1" --format '{{.State.Running}}' 2>/dev/null | grep -q "true"
}

get_container_state() {
    local name="$1"

    if ! podman container inspect "$name" >/dev/null 2>&1; then
        echo "n√£o criado"
        return
    fi

    if check_running "$name"; then
        echo "rodando"
    else
        echo "parado"
    fi
}

is_valid_database() {
    local service="$1"
    for db in "${DATABASES[@]}"; do
        if [ "$db" = "$service" ]; then
            return 0
        fi
    done
    return 1
}

start_database() {
    local service="$1"

    if ! is_valid_database "$service"; then
        echo -e "${RED}‚ùå Banco '$service' n√£o encontrado. Op√ß√µes: ${DATABASES[*]}${NC}"
        return 1
    fi

    if check_running "$service"; then
        echo -e "${YELLOW}‚ö†Ô∏è  $service j√° est√° rodando${NC}"
    else
        echo -e "${BLUE}üîå Iniciando $service...${NC}"
        podman start "$service" >/dev/null
        echo -e "${GREEN}‚úÖ $service iniciado${NC}"
    fi
}

stop_database() {
    local service="$1"

    if ! is_valid_database "$service"; then
        echo -e "${RED}‚ùå Banco '$service' n√£o encontrado. Op√ß√µes: ${DATABASES[*]}${NC}"
        return 1
    fi

    if check_running "$service"; then
        echo -e "${BLUE}üí§ Parando $service...${NC}"
        podman stop "$service" >/dev/null 2>&1
        echo -e "${GREEN}‚úÖ $service parado${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  $service j√° est√° parado${NC}"
    fi
}

start_all_dbs() {
    if [ ${#DATABASES[@]} -eq 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Nenhum banco configurado para iniciar.${NC}"
        return
    fi

    echo -e "${BLUE}üîå Iniciando todos os bancos...${NC}"
    for db in "${DATABASES[@]}"; do
        start_database "$db"
    done
}

stop_all_dbs() {
    if [ ${#DATABASES[@]} -eq 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Nenhum banco configurado para parar.${NC}"
        return
    fi

    echo -e "${BLUE}üí§ Parando todos os bancos...${NC}"
    for db in "${DATABASES[@]}"; do
        stop_database "$db"
    done
}

restart_database() {
    local service="$1"
    stop_database "$service"
    sleep 1
    start_database "$service"
}

restart_all_dbs() {
    if [ ${#DATABASES[@]} -eq 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Nenhum banco configurado para reiniciar.${NC}"
        return
    fi

    echo -e "${BLUE}üîÑ Reiniciando todos os bancos...${NC}"
    for db in "${DATABASES[@]}"; do
        restart_database "$db"
    done
}

show_db_status() {
    echo -e "${BLUE}üìä Status dos bancos:${NC}"

    if [ ${#DATABASES[@]} -eq 0 ]; then
        echo -e "  ${YELLOW}‚óã${NC} Nenhum banco configurado em $CONFIG_DIR/databases.conf"
        return
    fi

    for db in "${DATABASES[@]}"; do
        if check_running "$db"; then
            echo -e "  ${GREEN}‚óè${NC} $db (rodando)"
        else
            echo -e "  ${RED}‚óã${NC} $db (parado)"
        fi
    done
}

show_containers_status() {
    echo -e "${BLUE}üì¶ Status dos containers:${NC}"
    printf "%-12s | %-11s\n" "Container" "Estado"
    printf '%s\n' "-----------------------------"

    local missing=0

    for container in "${CONTAINERS[@]}"; do
        local state
        local color

        state=$(get_container_state "$container")

        case "$state" in
            "rodando")
                color="$GREEN"
                ;;
            "parado")
                color="$YELLOW"
                ;;
            "n√£o criado")
                color="$RED"
                missing=1
                ;;
        esac

        printf " %-11s | %b%s%b\n" "$container" "$color" "$state" "$NC"
    done

    if (( missing )); then
        echo -e "${YELLOW}‚ö†Ô∏è  Algum container n√£o foi encontrado. Execute 'devobox rebuild' para recriar.${NC}"
    fi
}

case "$1" in
    shell|enter)
        # Check if should start databases
        if [ "$2" = "--with-dbs" ]; then
            start_all_dbs
        fi

        if ! check_running "devobox"; then
             echo -e "${BLUE}   Iniciando Devobox...${NC}"
             podman start devobox >/dev/null
        fi
        echo -e "${GREEN}üöÄ Entrando no Devobox...${NC}"
        # Map current host directory to container path
        WORK_DIR=$(pwd | sed "s|$HOME|/home/dev|")
        # Test if directory exists in container, fallback to default
        podman exec devobox test -d "$WORK_DIR" 2>/dev/null || WORK_DIR="/home/dev/code"
        podman exec -it -w "$WORK_DIR" devobox bash
        exit_code=$?
        echo -e "${BLUE}üí§ Encerrando Devobox e bancos ap√≥s sair do shell...${NC}"
        stop_all_dbs
        podman stop devobox >/dev/null 2>&1 || true
        exit $exit_code
        ;;

    db)
        case "$2" in
            start)
                if [ -z "$3" ]; then
                    start_all_dbs
                else
                    start_database "$3"
                fi
                ;;
            stop)
                if [ -z "$3" ]; then
                    stop_all_dbs
                else
                    stop_database "$3"
                fi
                ;;
            restart)
                if [ -z "$3" ]; then
                    restart_all_dbs
                else
                    restart_database "$3"
                fi
                ;;
            status|ls)
                show_db_status
                ;;
            *)
                echo -e "${RED}‚ùå Subcomando inv√°lido para 'db'${NC}"
                echo "Uso: devobox db {start|stop|restart|status} [servi√ßo]"
                exit 1
                ;;
        esac
        ;;

    up)
        start_all_dbs
        podman start devobox >/dev/null 2>&1 || true
        echo -e "${GREEN}‚úÖ Ambiente rodando em background.${NC}"
        ;;

    down|stop)
        echo -e "${BLUE}üí§ Parando ambiente...${NC}"
        podman stop devobox "${DATABASES[@]}" >/dev/null 2>&1 || true
        echo -e "${GREEN}‚úÖ Tudo parado.${NC}"
        ;;

    status)
        show_containers_status
        ;;

    rebuild)
        echo -e "${BLUE}üèóÔ∏è  Reconstruindo ambiente...${NC}"
        cd "$CONFIG_DIR" && make build
        ;;

    *)
        show_help
        ;;
esac
