FROM docker.io/archlinux:latest

RUN sed -i 's/#ParallelDownloads = 5/ParallelDownloads = 5/g' /etc/pacman.conf && \
    pacman -Sy --noconfirm archlinux-keyring && \
    pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
      base-devel git curl openssh wget sudo \
      libffi zlib openssl readline ncurses libyaml gdbm \
      postgresql-libs redis imagemagick libvips \
      man-db neovim vi vim shadow tmux lazygit \
      ripgrep fd fzf unzip gzip tar xclip wl-clipboard \
      python python-pip python-pynvim python-virtualenv sqlite \
      cmake iputils iproute2 bind-tools && \
    pacman -Scc --noconfirm

RUN useradd -m -s /bin/bash dev && \
    echo "dev ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/dev

RUN mkdir -p /home/dev/.config/nvim && \
    mkdir -p /home/dev/.local/share/nvim && \
    mkdir -p /home/dev/.local/state/nvim && \
    mkdir -p /home/dev/.local/share/mise && \
    mkdir -p /home/dev/.config/mise && \
    mkdir -p /home/dev/.cache && \
    chown -R dev:dev /home/dev

RUN git clone https://github.com/JohnAnon9771/my-nvim.git /home/dev/.config/nvim || true && \
    sudo chown -R dev:dev /home/dev/.config/nvim && \
    sudo chmod -R u+w /home/dev/.config/nvim

USER dev
WORKDIR /home/dev

RUN curl https://mise.jdx.dev/install.sh | sh

ENV PATH="/home/dev/.local/bin:${PATH}"
RUN echo 'eval "$($HOME/.local/bin/mise activate bash)"' >> ~/.bashrc && \
    echo 'PS1="\[\e[1;36m\][devobox] \w \$ \[\e[0m\]"' >> ~/.bashrc
    
COPY --chown=dev:dev mise.toml /home/dev/.config/mise/config.toml

RUN mise install

CMD ["/bin/bash"]
