FROM docker.io/debian:bookworm-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git curl wget sudo \
    openssh-client \
    libssl-dev zlib1g-dev libreadline-dev libyaml-dev libncurses5-dev libffi-dev libgdbm-dev \
    libpq-dev redis-tools imagemagick libvips ripgrep fd-find \
    vim tmux unzip zip tar xclip \
    python3 python3-pip python3-venv \
    cmake iputils-ping iproute2 dnsutils ca-certificates && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# install nvim
RUN curl -LO https://github.com/neovim/neovim/releases/download/v0.11.5/nvim-linux-x86_64.tar.gz && \
    tar -C /opt -xzf nvim-linux-x86_64.tar.gz && \
    rm nvim-linux-x86_64.tar.gz && \
    ln -s /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim

# install lazygit
RUN LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | \grep -Po '"tag_name": *"v\K[^"]*') && \
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" && \
    tar xf lazygit.tar.gz lazygit && \
    sudo install lazygit -D -t /.local/bin/ && \
    rm lazygit.tar.gz lazygit

RUN useradd -m -s /bin/bash dev && \
    echo "dev ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/dev

RUN mkdir -p /home/dev/.config/nvim && \
    mkdir -p /home/dev/.local/share/nvim && \
    mkdir -p /home/dev/.local/state/nvim && \
    mkdir -p /home/dev/.local/share/mise && \
    mkdir -p /home/dev/.config/mise && \
    mkdir -p /home/dev/.cache && \
    chown -R dev:dev /home/dev

RUN git clone https://github.com/JohnAnon9771/my-nvim.git /home/dev/.config/nvim || true && \
    sudo chown -R dev:dev /home/dev/.config/nvim && \
    sudo chmod -R u+w /home/dev/.config/nvim

USER dev
WORKDIR /home/dev

RUN curl https://mise.jdx.dev/install.sh | sh

ENV PATH="/home/dev/.local/bin:${PATH}"

RUN echo 'eval "$($HOME/.local/bin/mise activate bash)"' >> ~/.bashrc && \
    echo 'PS1="\[\e[1;36m\][devobox] \w \$ \[\e[0m\]"' >> ~/.bashrc

COPY --chown=dev:dev mise.toml /home/dev/.config/mise/config.toml

RUN mise install

# install ia tools
RUN mise exec -- npm install -g \
    @anthropic-ai/claude-code \
    @openai/codex \
    @google/gemini-cli

CMD ["/bin/bash"]
